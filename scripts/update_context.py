#!/usr/bin/env python3
"""
Regenerate AI context files from current codebase.

This script generates files that help AI coding assistants understand the codebase:
- .llms/schema.sql - Database schema dump
- .llms/openapi.yaml - OpenAPI specification

Usage:
    python scripts/update_context.py
    # or
    just update-context
"""

import os
import subprocess
import sys
from pathlib import Path
from urllib.parse import urlparse

import yaml


def get_project_root() -> Path:
    """Get the project root directory."""
    return Path(__file__).parent.parent


def get_llms_dir() -> Path:
    """Get or create the .llms directory."""
    llms_dir = get_project_root() / ".llms"
    llms_dir.mkdir(exist_ok=True)
    return llms_dir


def parse_database_url(database_url: str) -> dict[str, str]:
    """Parse DATABASE_URL into connection parameters."""
    # Handle async URLs by converting to sync format for pg_dump
    url = database_url.replace("postgresql+asyncpg://", "postgresql://")
    parsed = urlparse(url)

    return {
        "host": parsed.hostname or "localhost",
        "port": str(parsed.port or 5432),
        "user": parsed.username or "postgres",
        "password": parsed.password or "",
        "database": parsed.path.lstrip("/") or "postgres",
    }


def generate_schema() -> bool:
    """Dump PostgreSQL schema to .llms/schema.sql.

    Returns:
        True if successful, False otherwise.
    """
    database_url = os.environ.get("DATABASE_URL")
    if not database_url:
        print("âš ï¸  DATABASE_URL not set, skipping schema generation")
        return False

    try:
        params = parse_database_url(database_url)

        # Build pg_dump command
        env = os.environ.copy()
        env["PGPASSWORD"] = params["password"]

        cmd = [
            "pg_dump",
            "--schema-only",
            "--no-owner",
            "--no-privileges",
            "--no-comments",
            "-h",
            params["host"],
            "-p",
            params["port"],
            "-U",
            params["user"],
            params["database"],
        ]

        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            env=env,
            timeout=30,
            check=False,  # We check returncode manually below
        )

        if result.returncode != 0:
            print(f"âŒ pg_dump failed: {result.stderr}")
            return False

        # Write schema file with header
        output_path = get_llms_dir() / "schema.sql"
        header = """-- =============================================================================
-- Agency Standard - Database Schema
-- =============================================================================
-- This file is auto-generated by scripts/update_context.py
-- Run `just update-context` to regenerate
--
-- Purpose: Provide AI coding assistants with database structure context
-- =============================================================================

"""
        output_path.write_text(header + result.stdout)
        print(f"âœ… Generated {output_path}")
        return True

    except FileNotFoundError:
        print("âŒ pg_dump not found. Install PostgreSQL client tools.")
        return False
    except subprocess.TimeoutExpired:
        print("âŒ pg_dump timed out")
        return False
    except Exception as e:
        print(f"âŒ Schema generation failed: {e}")
        return False


def generate_openapi() -> bool:
    """Export FastAPI OpenAPI spec to .llms/openapi.yaml.

    Returns:
        True if successful, False otherwise.
    """
    try:
        # Add src to path so we can import the app
        src_path = get_project_root() / "src"
        sys.path.insert(0, str(src_path))

        # Import and create the app (deferred import to avoid issues when app unavailable)
        from app.main import create_app  # noqa: PLC0415

        app = create_app()
        openapi_spec = app.openapi()

        # Write as YAML with header
        output_path = get_llms_dir() / "openapi.yaml"

        header = """# =============================================================================
# Agency Standard - OpenAPI Specification
# =============================================================================
# This file is auto-generated by scripts/update_context.py
# Run `just update-context` to regenerate
#
# Purpose: Provide AI coding assistants with API structure context
# =============================================================================

"""
        yaml_content = yaml.dump(
            openapi_spec,
            default_flow_style=False,
            sort_keys=False,
            allow_unicode=True,
        )

        output_path.write_text(header + yaml_content)
        print(f"âœ… Generated {output_path}")
        return True

    except ImportError as e:
        print(f"âŒ Failed to import app: {e}")
        print("   Make sure dependencies are installed: uv sync")
        return False
    except Exception as e:
        print(f"âŒ OpenAPI generation failed: {e}")
        return False


def main() -> int:
    """Main entry point.

    Returns:
        Exit code (0 for success, 1 for failure).
    """
    print("ğŸ”„ Updating AI context files...\n")

    results = []

    # Generate OpenAPI spec (doesn't require running services)
    results.append(generate_openapi())

    # Generate database schema (requires PostgreSQL connection)
    results.append(generate_schema())

    print()
    if all(results):
        print("âœ… AI context updated successfully")
        return 0
    elif any(results):
        print("âš ï¸  AI context partially updated (some files skipped)")
        return 0
    else:
        print("âŒ AI context update failed")
        return 1


if __name__ == "__main__":
    sys.exit(main())

