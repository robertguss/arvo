# Agency Standard - AI Coding Rules

## Overview

This is a FastAPI application using SQLAlchemy 2.0 async with multi-tenancy support.
Follow the Service-Repository pattern strictly.

## Architecture

- **Modular Monolith**: Single deployable unit with strict internal boundaries
- **Layering**: Routes → Services → Repositories → Models
- Never import repositories from routes; always go through services
- Routes cannot import Repositories. Services cannot import Routes.

## Directory Structure

```text
src/app/
├── main.py           # Application factory (create_app)
├── config.py         # Settings via pydantic-settings
├── core/             # Cross-cutting concerns
│   └── database/     # Session, base models, mixins
├── modules/          # Feature modules
│   └── {module}/
│       ├── routes.py
│       ├── schemas.py
│       ├── services.py
│       ├── repos.py
│       └── models.py
└── api/              # API router and dependencies
```

## Conventions

### Dependency Injection

Use `Annotated[X, Depends(Y)]` for all dependencies:

```python
from typing import Annotated
from fastapi import Depends

async def get_items(
    service: Annotated[ItemService, Depends()],
    current_user: Annotated[User, Depends(get_current_user)],
) -> list[Item]:
    return await service.list()
```

### API Endpoints

All endpoints must have:

- `response_model` - Pydantic model for response
- `summary` - Brief description for OpenAPI
- `tags` - Categorization

```python
@router.post(
    "/items",
    response_model=ItemResponse,
    status_code=201,
    summary="Create a new item",
    tags=["items"],
)
async def create_item(data: ItemCreate) -> ItemResponse:
    ...
```

### Database Models

- Inherit from `Base` (declarative base)
- Use mixins: `UUIDMixin`, `TimestampMixin`, `TenantMixin`
- All tenant-scoped models MUST use `TenantMixin`

```python
from app.core.database import Base, TenantMixin, TimestampMixin, UUIDMixin

class Item(Base, UUIDMixin, TimestampMixin, TenantMixin):
    __tablename__ = "items"
    name: Mapped[str] = mapped_column(String(255))
```

### Schemas (Pydantic)

Use Pydantic `BaseModel` for all request/response schemas:

```python
from pydantic import BaseModel

class ItemCreate(BaseModel):
    name: str

class ItemResponse(BaseModel):
    id: UUID
    name: str
    created_at: datetime

    model_config = ConfigDict(from_attributes=True)
```

## Multi-Tenancy

- Every request has a tenant context
- Repositories automatically filter by `tenant_id`
- Never query without tenant context unless explicitly bypassing for admin

## Commands

- `just dev` — Start development server
- `just test` — Run all tests
- `just lint` — Lint and type-check
- `just fix` — Auto-fix linting issues
- `just migrate` — Run database migrations
- `just migration "name"` — Create new migration
- `just seed` — Generate demo data

## Testing

- Unit tests: `tests/unit/`
- Integration tests: `tests/integration/`
- Use factories from `tests/factories/`
- Use `pytest.mark.asyncio` for async tests
